name: CI

# This workflow runs tests and lints the JavaScript codebase.
# It is triggered on pushes to the main branch and on pull requests.

permissions: read-all

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        # Cache npm dependencies for faster installs.

    - name: Install dependencies
      run: npm ci
      # Use 'npm ci' for deterministic installs in CI environments.

    - name: Run Linters and Formatters (Biome)
      run: npx @biomejs/biome check --apply src/
      # Use Biome for ultra-fast linting and formatting. '--apply' attempts to fix violations.

    - name: Run Tests (Vitest)
      run: npm run test:ci
      # This assumes a 'test:ci' script in package.json that runs Vitest.
      # Example package.json script: "test:ci": "vitest run --coverage"

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        # Ensure CODECOV_TOKEN is set in repository secrets.
        # This step uploads coverage data for analysis.

    # For browser extensions, E2E testing might involve more complex setups (e.g., Playwright)
    # If Playwright is used, uncomment and configure the following steps:
    # - name: Install Playwright browsers
    #   run: npx playwright install
    # - name: Run End-to-End Tests (Playwright)
    #   run: npm run test:e2e
    #   env:
    #     CI: true
    #     # Ensure PLAYWRIGHT_BASE_URL is set if needed.

    - name: Check for license headers (if applicable)
      # Example: If a tool like 'license-checker' or custom script is used.
      # run: npm run check-licenses
      pass
      # Placeholder for potential license header checks.

    - name: Upload artifact for review (optional)
      # This step can be used to upload built extension files for manual inspection.
      # Consider what build artifacts are relevant for a browser extension.
      # If using Vite for building:
      #   run: npm run build
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: cogniread-extension-build
      #     path: dist/ # Or the relevant build output directory
      pass
